async function fetchNivo(resource) {
  const url = `https://api.beebotte.com/v1/data/read/${CHANNEL}/${resource}?limit=1`;
  try {
    const response = await fetch(url, {
      headers: { "X-Auth-Token": TOKEN }
    });
    const data = await response.json();
    if (!data || data.length === 0) return { value: null, offline: true };

    const vrednost = parseFloat(data[0].data);
    const timestamp = new Date(data[0].created_at);
    const sada = new Date();
    const razlikaSekunde = (sada - timestamp) / 1000;

    const offline = razlikaSekunde > 20; // prag za offline status
    return { value: offline ? null : vrednost, offline };
  } catch (error) {
    console.error(`Greška pri čitanju ${resource}:`, error);
    return { value: null, offline: true };
  }
}

async function update() {
  const rezultat1 = await fetchNivo(RESOURCE1);
  const rezultat2 = await fetchNivo(RESOURCE2);
  const vreme = new Date().toLocaleTimeString();

  if (rezultat1.offline) {
    nivo1Label.textContent = "Bunar 1: OFFLINE";
  } else {
    nivo1Label.textContent = `Bunar 1: ${rezultat1.value.toFixed(2)} m`;
    grafikon1.data.labels.push(vreme);
    grafikon1.data.datasets[0].data.push(rezultat1.value);
    grafikon1.update();
    if (grafikon1.data.labels.length > 20) {
      grafikon1.data.labels.shift();
      grafikon1.data.datasets[0].data.shift();
    }
  }

  if (rezultat2.offline) {
    nivo2Label.textContent = "Bunar 2: OFFLINE";
  } else {
    nivo2Label.textContent = `Bunar 2: ${rezultat2.value.toFixed(2)} m`;
    grafikon2.data.labels.push(vreme);
    grafikon2.data.datasets[0].data.push(rezultat2.value);
    grafikon2.update();
    if (grafikon2.data.labels.length > 20) {
      grafikon2.data.labels.shift();
      grafikon2.data.datasets[0].data.shift();
    }
  }
}
